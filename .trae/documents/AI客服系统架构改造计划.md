# AI客服系统架构改造计划

## 🎯 核心目标
- **用户不直接连接API**：所有API调用通过后端服务器
- **知识库比对**：所有内容先经过知识库检索再调用AI
- **系统提示词定位**：基于产品模块名称设置AI身份
- **解决混合内容错误**：消除HTTPS/HTTP冲突

## 🏗️ 架构改造

### 1. 后端架构实现

**API设计**：
- `/api/chat` - 文本聊天处理
- `/api/analyze` - 图片分析处理
- `/api/video` - 视频聊天处理
- `/api/ocr` - 文字识别处理
- `/api/health` - 健康检查

**处理流程**：
1. **接收请求**：获取用户消息和项目ID
2. **加载知识库**：根据项目ID加载对应知识库
3. **知识库检索**：使用向量模型进行相似度匹配
4. **构建上下文**：将检索结果与系统提示词组合
5. **调用AI模型**：发送完整上下文给Zhipu API
6. **处理响应**：解析AI响应并返回给前端

### 2. 前端架构优化

**简化前端逻辑**：
- 移除所有API密钥处理代码
- 移除前端知识库检索逻辑
- 使用相对路径调用后端API
- 专注于UI和用户交互

**功能实现**：
- 文本输入和发送
- 语音录制和上传
- 图片选择和上传
- 视频流处理
- 加载状态和错误提示

### 3. 知识库检索优化

**实现方式**：
- 在后端使用Zhipu的embedding模型
- 对用户查询和知识库文档进行向量化
- 计算余弦相似度进行排序
- 提取最相关的知识库条目

**优化策略**：
- 缓存知识库嵌入向量
- 批量处理知识库文档
- 设置合理的相似度阈值

### 4. 系统提示词优化

**动态提示词生成**：
- 基于产品模块名称设置AI身份
- 包含产品知识库信息
- 定义清晰的角色和任务
- 设置响应格式和风格要求

**示例提示词**：
```
你是「${productName}」的专业技术支持专家。请基于产品知识库提供准确的解决方案。

知识库内容：
${knowledgeBaseContent}

用户问题：
${userQuestion}

请提供专业、详细的回答，引用知识库内容。
```

### 5. 混合内容错误解决

**技术方案**：
- 使用相对路径：`/api/chat` 替代绝对路径
- 配置Vercel代理：将API请求代理到后端
- 后端HTTPS配置：生产环境使用HTTPS

**部署策略**：
- 前端部署到Vercel
- 后端部署到云服务器或使用Serverless Functions

## 📋 实施步骤

### 第一阶段：后端基础架构
1. **创建后端API**：实现核心API接口
2. **知识库管理**：实现知识库加载和检索
3. **AI集成**：实现Zhipu API调用
4. **错误处理**：完善错误处理和日志记录

### 第二阶段：前端改造
1. **API调用优化**：使用相对路径调用后端API
2. **逻辑简化**：移除前端知识库检索和API密钥处理
3. **状态管理**：优化加载状态和错误提示
4. **响应式设计**：确保移动端体验

### 第三阶段：知识库系统
1. **向量检索**：实现基于向量的知识库检索
2. **相似度计算**：优化相似度算法
3. **上下文构建**：智能构建AI模型上下文
4. **性能优化**：缓存和批量处理

### 第四阶段：系统提示词
1. **动态生成**：基于产品模块生成提示词
2. **角色定位**：明确AI身份和职责
3. **格式规范**：统一响应格式和风格
4. **效果评估**：测试提示词效果

### 第五阶段：部署优化
1. **混合内容修复**：配置HTTPS和代理
2. **性能测试**：压力测试和优化
3. **安全加固**：API密钥管理和访问控制
4. **监控部署**：实现系统监控和报警

## ✅ 预期效果

**功能完善**：
- ✅ 文本聊天 - 后端处理知识库检索和AI调用
- ✅ 语音识别 - 后端处理语音转文本和AI调用
- ✅ 图片分析 - 后端处理图片分析和AI调用
- ✅ 视频功能 - 后端处理视频分析和AI调用
- ✅ OCR识别 - 后端处理文字识别和AI调用

**技术优势**：
- ✅ 安全性提升 - API密钥完全不暴露
- ✅ 性能优化 - 减轻前端负担
- ✅ 一致性保证 - 所有逻辑集中管理
- ✅ 扩展性增强 - 支持更多功能和数据源

**用户体验**：
- ✅ 响应速度更快
- ✅ 功能更加稳定
- ✅ 错误提示更友好
- ✅ 界面更加流畅

## 🛠️ 技术栈

**后端**：
- Node.js + Express
- Axios (HTTP客户端)
- FormData (文件处理)
- Dotenv (环境变量管理)

**前端**：
- React 19.2.4 + TypeScript
- Tailwind CSS
- Lucide React (图标)

**AI集成**：
- Zhipu AI API
- GLM-4.7 (文本)
- GLM-4.6v (多模态)
- GLM-4-voice (语音)
- Embedding-3 (向量模型)

## 📱 部署方案

**开发环境**：
- 前端：`npm run dev` (http://localhost:3001)
- 后端：`npm run start` (http://localhost:3002)

**生产环境**：
- 前端：Vercel部署
- 后端：云服务器或Serverless Functions
- API代理：Vercel配置或Nginx反向代理

## 🎯 成功标准

1. **用户不直接连接API** - 所有API调用通过后端
2. **知识库比对** - 所有内容先经过知识库检索
3. **系统提示词定位** - 基于产品模块名称设置身份
4. **混合内容错误解决** - 无HTTPS/HTTP冲突
5. **功能完整** - 所有核心功能正常工作
6. **性能稳定** - 响应速度快，无卡顿

## 📋 项目文件结构

```
├── backend/
│   ├── server.js          # 后端服务器
│   ├── package.json       # 后端依赖
│   └── .env               # 环境变量
├── services/
│   └── aiService.ts       # AI服务（简化版）
├── components/
│   ├── UserPreview.tsx    # 用户界面
│   └── ...
├── types/
│   └── index.ts          # 类型定义
├── vite.config.ts        # Vite配置
└── package.json          # 前端依赖
```